# Estimating Photovoltaic Potential in the Built Environment of Municipalities Using Lidar Data

## Project Description
This project aims to enable modelling of photovoltaic (PV) potential in the built environment of different municipalities using lidar (light detection and ranging) data and building footprints. Different free, open source platforms have been used in the process. Various packages from WhiteboxTools Open Core in Python are used for lidar data analysis. For solar resource modeling, pvlib is used on the Python platform.

The authors used the code with Canadian municipalities. Users should acquire lidar data and building footprints to use with the code. [lidar](https://open.canada.ca/data/en/dataset/7069387e-9986-4297-9f55-0288e9676947) and [building footprints](https://open.canada.ca/data/en/dataset/7a5cda52-c7df-427f-9ced-26f19a8a64d6)  can be downloaded for free from databases created by the Canada Centre for Mapping and Earth Observation (CCMEO). 

The code developed calculates the PV capacity and electricity generation for different municipalities across Canada. The code was used to generate the results described in a report [published by CanmetENERGY in Varennes](https://natural-resources.canada.ca/science-data/science-research/research-centres/assessing-photovoltaic-potential-canadian-building-stock)
The National Renewable Energy Laboratory (NREL) National Solar Radiation Database (NSRDB) should be used for all meteorological data except those above a latitude of 60Â°, in which case [Canadian Weather Year for Energy Calculation (CWEC)](https://open.canada.ca/data/en/dataset/55438acb-aa67-407a-9fdb-1cb21eb24e28) can be used in epw format. QGIS was used primarily for visualization, but also for rasterization, in the event that there were errors with the code to change data projections and clip shapefiles.

## Usage
 
The flowchart below explains the process used within the code.

![Code flowchart](images/PV_potential_code_diagram_report.png)  

Reusable functions for this project are contained in the \tools directory. Each function's header contains a function description. The script **Example_script.py** provides an example of how the code can be run. 

A full listing of the contents of each directory is contained below in the "Brief description of directories and files" section.

## Runtime Dependencies

Code was run with python 3.10.9.

**Important note:** the code should be run on a computer that can handle large amounts of data quickly. It is best to use a computer with a fast processing time and with a memory above 60 GB, but this will depend on how large the .tif and .las files are and how large the area of interest is.

The requirements.txt file can be used to re-create the Python environment that was used to run the scripts. 
The package GDAL needs to be installed separately. The file to install for Python 3.10 is under the folder env.

## Brief description of directories and files

All python files are listed below by directory with a short description.

**Main Directory**

*Example_script.py:* run this file to complete the analysis. The user must specify some input parameters, including what municipality the user wishes to run.

*run_methods.py:* contains functions to run the technical potential analysis with shading computing either for each timestep in the year, or else for selected representative days. This file also contains methods to print to console and write to an excel file and text file a summary of the results.

*location.py:* this contains user-supplied paths for all the files needed for the analysis and all the files generated by the analysis. These include the mosaic digital surface model (DSM) file, the building footprint shapefile, the segmentation shapefile, the rasterized segmentation file, the lidar files and the weather file (based on the municipality). This file also includes functions to run the Lidar.py and Segmentation.py files. Other input parameters are the latitude, longitude and time zone (UTC offset) for each municipality. 

*Lidar.py:* This creates a DSM from a lidar point cloud. 
A DSM reflects the elevation of the tops of all off-terrain objects (i.e. non-ground features) contained within the data set.
The user must specify some input parameters based on the lidar datasets. There is also a function used to combine multiple images created by the DSM method, to make a single raster file.

*TimeInDaylight.py:* This calculates the proportion of time each grid cell in the DSM is unshaded on an hourly and annual basis. It includes functions to validate the code and different methodologies for calculating the shading. The generated DSM file from Lidar.py is used as an input for this tool.

*POA:* Calculates the hourly and annual sum of the plane of array (POA) irradiance for each rooftop segment including the impact of shading. 

*Segmentation.py:* This is used to identify rooftop segments from the lidar point cloud. In addition to lidar data, the building footprints (vector) file is required for this tool. (In this project the building footprint data were generated by CCMEO from the associated lidar data).

Note: To be able to run this tool, the coordinate system of the building footprints should be reprojected to match that of the lidar data. The reprojected building footprints shapefile should be in the same folder as the lidar data. The loop in this file generates segments using different input parameters. (Eventually, we selected threshold=0.4 and norm_diff=5.0 for subsequent analysis.)

*economic_analysis:* used to calculate the simple payback by solar resource bin.


**Directory: \tools**

*file_handle.py:* used to read and write the shading data.

*lidar_functions.py:* used to get the info for each lidar file, including the average point cloud density (outputted and summarized into an excel sheet) and used to convert the .laz format (compressed lidar files) to .las files (can then be used for the analysis).

*spatial_toolset.py:* used to convert the segmentation vector file to a raster file without the need of another program such as QGIS or ArcGIS.

**Directory: \WBT**

This directory was downloaded from [WhiteboxTools Open Core](https://www.whiteboxgeo.com/) and is used to perform specific functionality within the code to generate the DSM files and assemble them into a mosaic, create rooftop segments, and calculate the shading on each segment.


## Authors
Erin Gaucher-Loksts: (erin.gaucher-loksts@nrcan-rncan.gc.ca)

Sophie Pelland: (sophie.pelland@nrcan-rncan.gc.ca)

The work built on code developed by Negar Salimzadeh (negar_dooman@yahoo.com) under the same project.



